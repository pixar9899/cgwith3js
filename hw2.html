<!DOCTYPE html>
<html>

<head>
    <title>HW1-time-based animation</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link href="style.css" rel="stylesheet">
    <style>
        #canvas {
            padding: 25px 0;
            margin-left: auto;
            margin-right: auto;
            display: block;
            width: 600px;
        }

        /* 增加button間距 */
        #navbtn button {
            margin: 0 10px;
        }
    </style>
</head>

<body>
    <div id="canvas"></div>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/108/three.min.js"></script>
    <script src="https://threejs.org/examples/js/controls/OrbitControls.js">
    </script>
    <script>
        //檢查FPS
        javascript: (function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = 'https://mrdoob.github.io/stats.js/build/stats.min.js'; document.head.appendChild(script); })();
        //必要全域變數
        var scene, camera, renderer;
        var clock;
        //坦克車
        var tank, parts;
        //砲彈陣列
        var balls = [];
        //鍵盤事件
        var keyboard = new KeyboardState();

        class Ball {
            constructor(mesh, x = 0, y = 0, z = 0, vx, vy) {
                this.mesh = mesh;
                scene.add(this.mesh);
                this.pos = new THREE.Vector3(x, y, z);  // 初始位置
                this.vel = new THREE.Vector3(vx, vy, 0); // 初速
                this.force = new THREE.Vector3(0, -20, 0); // 重力
                this.m = 2;
            }
            update(dt) {
                this.vel.add(this.force.clone().multiplyScalar(dt / this.m));
                this.pos.add(this.vel.clone().multiplyScalar(dt));

                if (this.pos.y < 0) {
                    this.pos.y = 0;
                    this.vel.y *= -0.85;
                }
                if (this.pos.x > 100) {
                    // remove from scene (自己做)
                    //從場景中移除這個ball
                    scene.remove(this.mesh);
                    //砲彈陣列的全域變數
                    // balls.shift();
                }
                this.mesh.position.copy(this.pos);
            }
        }

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            let width = 600;
            let height = 450;
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(width, height);
            renderer.setClearColor('white');
            $('#canvas').append(renderer.domElement);
            camera = new THREE.PerspectiveCamera(
                80,
                width / height,
                1,
                1000);
            camera.position.x = 0;
            camera.position.y = 50;
            camera.position.z = 100;
            //算時間差
            clock = new THREE.Clock();
            //把坦克部件抓出來
            parts = bulidPart();
            //坦克放入場景
            tank = buildTank(parts);
            scene.add(tank);
            let controls = new THREE.OrbitControls(camera, renderer.domElement);
            camera.lookAt(scene.position);
        }
        function bulidPart() {
            //預設材質
            let mat = new THREE.MeshNormalMaterial();
            let parts = [];
            //車身
            let base = new THREE.Mesh(new THREE.BoxGeometry(40, 10, 20), mat);
            parts.push(base);
            //砲塔
            let turret = new THREE.Mesh(new THREE.CylinderGeometry(10, 10, 10, 30), mat);
            parts.push(turret);
            //砲管
            let cannon = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 10, 30), mat);
            parts.push(cannon);
            //砲軸
            let turn = new THREE.Mesh(new THREE.CylinderGeometry(1.5, 1.5, 10, 30), mat);
            parts.push(turn);
            return parts;
        }
        function buildTank(parts) {
            //坦克車集合
            let tank = new THREE.Object3D();

            let base = parts[0];
            base.position.set(-10, 5, 0);
            tank.add(base);

            let turret = parts[1];
            turret.position.set(0, 15, 0);
            tank.add(turret);

            let turn = parts[2];
            turn.position.x = 10;
            turn.rotation.x = Math.PI / 2;
            turret.add(turn);

            let cannon = parts[3];
            cannon.rotation.z = Math.PI / 2;
            cannon.position.set(5, 0, 0);
            turn.add(cannon);
            return tank;
        }
        function animate() {
            let dt = clock.getDelta();
            balls.forEach(function (b) { b.update(dt) });

            requestAnimationFrame(animate);
            renderer.render(scene, camera);
            keyboard.update();
            if (keyboard.pressed("W")) {
                tank.position.x += 0.1 * Math.cos(tank.rotation.y);
                tank.position.z -= 0.1 * Math.sin(tank.rotation.y);
            }
            if (keyboard.pressed("S")) {
                tank.position.x -= 0.1 * Math.cos(tank.rotation.y);
                tank.position.z += 0.1 * Math.sin(tank.rotation.y);
            }
            // if (keyboard.pressed("A")) {
            //     tank.rotation.y += 0.01;
            // }
            // if (keyboard.pressed("D")) {
            //     tank.rotation.y -= 0.01;
            // }
            if (keyboard.pressed("I")) {
                //只能往上到60度，不然穿模太嚴重
                if (parts[2].rotation.y < Math.PI / 3)
                    parts[2].rotation.y += 0.01;
            }
            if (keyboard.pressed("K")) {
                //只能往下到-60度，不然穿模太嚴重
                if (parts[2].rotation.y > -Math.PI / 3)
                    parts[2].rotation.y -= 0.01;
            }
            if (keyboard.down("space")) {
                //抓出旋轉軸
                let turn = parts[2];
                //抓出砲管
                let cannon = parts[3];
                //取得旋轉軸的位置
                let tGPW = turn.getWorldPosition();
                //取得砲管的位置
                let cGPW = cannon.getWorldPosition();
                let ball = new THREE.Mesh(new THREE.SphereGeometry(1, 20, 20),
                    new THREE.MeshNormalMaterial());
                //砲彈的初始位置會是砲管中心位置的兩倍減去轉動軸的位置
                //旋轉軸的y軸旋轉度數會等於要射出砲彈的方向，砲彈是斜拋...
                //固定速度為30，所以拆水平跟垂直分力，然後用旋轉度數取正餘弦函數*30
                balls.push(new Ball(ball, 2 * cGPW.x - tGPW.x, 2 * cGPW.y - tGPW.y, 2 * cGPW.z - tGPW.z
                    , Math.cos(turn.rotation.y) * 30, Math.sin(turn.rotation.y) * 30));
            }
            // console.log();
        }
    </script>
</body>